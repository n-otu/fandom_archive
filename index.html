<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Fandom Archive</title>
    <script type="importmap">
      {
        "imports": {
          "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
          "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
          "@graffiti-garden/implementation-remote": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-remote@0.6.2/dist/browser/index.js",
          "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs",
          "@graffiti-garden/wrapper-files": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-files@0.0.1/dist/browser/index.js",
          "@graffiti-garden/wrapper-files/vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-files@0.0.1/dist/vue/index.mjs"
        }
      }
    </script>
    <link rel="stylesheet" href="style.css" />
  </head>



  <body>

    <!-- buffering!  -->
    <div id="loading-screen">
      <img src="./media/loading cat.gif" alt="Loading..." class="loading-gif" />
      <p>Loading The Fandom Archive...</p>
    </div>

    <div id="app">

      <!-- navigation section -->
      <nav>
        <button :class="{ active: currentTab === 'forums' }" @click="currentTab = 'forums'">Forums</button>
        <button :class="{ active: currentTab === 'home' }" @click="currentTab = 'home'">Home</button>
        <button :class="{ active: currentTab === 'channels' }" @click="currentTab = 'channels'">Channels</button>


        <!-- Always show the profile button if logged in!! -->
        <template v-if="$graffitiSession?.value?.actor">
          <graffiti-discover
            v-slot="{ objects }"
            :channels="[$graffitiSession.value.actor]"
            :schema="{
              properties: {
                value: {
                  required: ['describes'],
                  properties: {
                    describes: { type: 'string' },
                    icon: { type: 'string' },
                    published: { type: 'number' }
                  }
                }
              }
            }"
          >
            <template v-if="objects.length > 0 && objects[0].value.icon">
              <graffiti-get
                :url="objects.slice().sort((a, b) => (b.value.published || 0) - (a.value.published || 0))[0].value.icon"
                :schema="graffitiFileSchema"
                v-slot="{ object }"
              >
                <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
                  <button @click="viewingProfileOf = $graffitiSession.value.actor; currentTab = 'profile'" class="profile-tab-button" aria-label="Profile">
                    <img :src="fileDataUrl" style="width: 5rem; height: 5rem; border-radius: 50%" />
                  </button>
                </graffiti-object-to-file>
              </graffiti-get>
            </template>

            <!-- fallback profile button if no image is there -->
            <template v-else>
              <button @click="currentTab = 'profile'" class="profile-tab-button" aria-label="Profile">👤</button>
            </template>
          </graffiti-discover>
        </template>


      </nav>

      <button v-if="!$graffitiSession?.value" @click="$graffiti.login()" id="login">Log In</button>
      <button v-if="$graffitiSession?.value" @click="$graffiti.logout($graffitiSession.value)" id="logout">Log Out</button>

      <section v-if="currentTab === 'profile' && viewingProfileOf">
        <h2>Profile</h2>

        <graffiti-discover
          v-slot="{ objects }"
          :channels="[viewingProfileOf]"
          :schema="{
            properties: {
              value: {
                required: ['describes'],
                properties: {
                  describes: { type: 'string' },
                  name: { type: 'string' },
                  pronouns: { type: 'string' },
                  bio: { type: 'string' },
                  icon: { type: 'string' },
                  published: { type: 'number' }
                }
              }
            }
          }"
        >
          <template v-if="objects.length > 0">
            <template v-if="latestProfile = objects.slice().sort((a, b) => (b.value.published || 0) - (a.value.published || 0))[0].value">
              <div class="profile-container">
                <div class="profile-pic-wrapper">
                  <graffiti-get
                    v-if="latestProfile.icon"
                    :url="latestProfile.icon"
                    :schema="graffitiFileSchema"
                    v-slot="{ object }"
                  >
                    <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
                      <img
                        :src="fileDataUrl"
                        alt="Profile picture"
                        style="width: 10rem; height: 10rem; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem"
                      />

                    </graffiti-object-to-file>
                  </graffiti-get>

                  <img
                    v-else
                    src="media/blank-profile-picture.webp"
                    alt="Default profile"
                    style="width: 10rem; height: 10rem; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem"
                  />
                </div>

                <div class="profile-info">
                  <p><strong>Username:</strong> {{ getShortUsername($graffitiSession.value.actor) }}</p>
                  <p><strong>Display Name:</strong> {{ latestProfile.name || '(none)' }}</p>
                  <p><strong>Pronouns:</strong> {{ latestProfile.pronouns || '(none)' }}</p>
                  <p><strong>Bio:</strong> {{ latestProfile.bio || '(none)' }}</p>
                </div>
              </div>
            </template>
          </template>

          <template v-else>
            <p>No profile found yet. Fill out the form below to create one.</p>
          </template>

           <!-- Only allow editing if it's your own profile -->
          <template v-if="viewingProfileOf === $graffitiSession?.value?.actor">
            <button @click="showProfileForm = !showProfileForm">
              {{ showProfileForm ? 'Done' : 'Edit Profile' }}
            </button>
          <form v-if="showProfileForm" @submit.prevent="submitProfile" class="edit-profile-form">
              <input v-model="profileName" placeholder="Display Name" />
              <input v-model="profilePronouns" placeholder="Pronouns" />
              <textarea v-model="profileBio" placeholder="Short bio"></textarea>
              <input type="file" @change="upload_file" />
              <button type="submit">Save Profile</button>
            </form>
            </template>
          </graffiti-discover>
      </section>


            <!-- each tab of chat app, code and functionality separated -->
            <section v-if="currentTab === 'home'" id="home">
                <h1>The Fandom Archive</h1>


                <div class="post">
                    <div class="post-header">
                    <img src="./media/images.jpeg" alt="User avatar" class="avatar" />
                    <strong>user123</strong>
                    </div>
                    <p> dummy content dummy content dummy content dummy content dummy content dummy content dummy content </p>
                    <like-button :initial-likes="0" />
                </div>

                <div class="post">
                    <div class="post-header">
                    <img src="./media/images.jpeg" alt="User avatar" class="avatar" />
                    <strong>randomFan42</strong>
                    </div>
                    <video controls width="100%">
                        <source src="./media/7c24a9500653b78394f629b50b5c969c.mp4" type="video/mp4" />
                        Your browser does not support the video tag.
                      </video>

                      <p>Just reread the final chapter—still not over it 😭</p>

                      <like-button :initial-likes="0" />
                </div>

                <div class="post">
                    <div class="post-header">
                    <img src="./media/images.jpeg" alt="User avatar" class="avatar" />
                    <strong>cool_username</strong>
                    </div>
                    <p><em> dummy content dummy content dummy content dummy content dummy content dummy content</em></p>
                    <like-button :initial-likes="0" />
                </div>
            </section>

            <section v-if="currentTab === 'forums'" id="forums">

              <template v-if="!selectedChannel">
                <h1>Forums Page!</h1>


                <!-- create forums -->
                <button @click="showNewForumModal = !showNewForumModal">
                  {{ showNewForumModal ? 'Hide New Forum Form' : 'New Forum' }}
                </button>

                <Popup v-if="showNewForumModal" @close="showNewForumModal = false">
                  <h3>Create a New Forum</h3>
                  <form @submit.prevent="create_forum($graffitiSession.value)">
                    <input v-model="newForumName" placeholder="Forum Name" />
                    <input v-model="newForumTopic" placeholder="Topic (e.g. books, shows)" />
                    <textarea v-model="newForumDescription" placeholder="Forum Description (optional)"></textarea>
                    <input type="file" @change="upload_forum_icon" />
                    <button type="submit">Create</button>
                  </form>
                </Popup>


                </graffiti-discover>


                <graffiti-discover
                  v-slot="{ objects }"
                  :channels="['global-forums']"
                  :schema="{
                    properties: {
                      value: {
                        required: ['activity', 'object'],
                        properties: {
                          activity: { const: 'Create' },
                          object: {
                            required: ['type', 'name', 'topic', 'channel'],
                            properties: {
                              type: { const: 'Forum' },
                              name: { type: 'string' },
                              topic: { type: 'string' },
                              channel: { type: 'string' }
                            }
                          }
                        }
                      }
                    }
                  }"
                >
                  <template v-if="(forumObjects = objects)">

                <h2>Favorite Forums 𐙚 ‧₊˚ ⋅</h2>


                <ul>
                  <li
                      v-for="forum in starredChannels
                        .map(s => forumObjects.find(f => f.value.object.channel === s.value.object))
                        .filter(f => f)"
                      :key="forum.url"
                    >
                    <div class="forum-card" @click="join_forum(forum.value.object.channel)">
                      <div class="forum-meta">
                        <template v-if="forum.value.object.icon">
                          <graffiti-get
                            :url="forum.value.object.icon"
                            :schema="graffitiFileSchema"
                            v-slot="{ object }"
                          >
                            <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
                              <img :src="fileDataUrl" class="forum-icon" alt="Forum icon" />
                            </graffiti-object-to-file>
                          </graffiti-get>
                        </template>

                        <div>
                          <strong>{{ forum.value.object.name }}</strong><br />
                          <small>#{{ forum.value.object.topic }}</small><br />
                          <p v-if="forum.value.object.description" class="forum-description">
                            {{ forum.value.object.description }}
                          </p>
                        </div>
                      </div>

                      <graffiti-discover
                        :channels="[forum.value.object.channel]"
                        :schema="{
                          properties: {
                            value: {
                              required: ['content', 'published'],
                              properties: {
                                content: { type: 'string' },
                                published: { type: 'number' }
                              }
                            }
                          }
                        }"
                        v-slot="{ objects: messages }"
                      >
                      <div class="forum-interactions">
                        <like-button
                          :initial-likes="forum_like_count(forum.value.object.channel)"
                          @liked="() => like_forum(forum.value.object.channel)"
                        />
                        <p class="forum-stats">{{ forum_like_count(forum.value.object.channel) }} liked this forum</p>
                        <p class="forum-stats">{{ messages.length }} messages</p>
                      </div>

                      </graffiti-discover>



                    </div>
                  </li>
                </ul>

                  <hr />



                <h2>Explore</h2>

                <!-- filtering -->
                <label>
                    Filter by topic:
                    <select v-model="selectedForumTopic">
                      <option value="All">All</option>
                      <option
                        v-for="topic in [...new Set(forumObjects.map(f => f.value.object.topic))]"
                        :key="topic"
                        :value="topic"
                      >
                        {{ topic }}
                      </option>
                    </select>
                  </label>

                  <ul>
                    <li
                      v-for="forum in forumObjects.filter(f =>
                        selectedForumTopic === 'All' || f.value.object.topic === selectedForumTopic
                      )"
                      :key="forum.url"
                    >
                    <div class="forum-card" @click="join_forum(forum.value.object.channel)">
                      <div class="forum-meta">
                        <template v-if="forum.value.object.icon">
                          <graffiti-get
                            :url="forum.value.object.icon"
                            :schema="graffitiFileSchema"
                            v-slot="{ object }"
                          >
                            <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
                              <img :src="fileDataUrl" class="forum-icon" alt="Forum icon" />
                            </graffiti-object-to-file>
                          </graffiti-get>
                        </template>

                        <div>
                          <strong>{{ forum.value.object.name }}</strong><br />
                          <small>#{{ forum.value.object.topic }}</small><br />
                          <p v-if="forum.value.object.description" class="forum-description">{{ forum.value.object.description }}</p>
                        </div>
                      </div>

                      <graffiti-discover
                        :channels="[forum.value.object.channel]"
                        :schema="{
                          properties: {
                            value: {
                              required: ['content', 'published'],
                              properties: {
                                content: { type: 'string' },
                                published: { type: 'number' }
                              }
                            }
                          }
                        }"
                        v-slot="{ objects: messages }"
                      >
                        <p class="forum-stats">{{ messages.length }} messages</p>
                      </graffiti-discover>

                      <like-button
                      :initial-likes="forum_like_count(forum.value.object.channel)"
                      @liked="() => like_forum(forum.value.object.channel)"
                    />

                      <p class="forum-stats">
                        {{ forum_like_count(forum.value.object.channel) }} liked this forum
                      </p>


                    </div>

                    </li>
                  </ul>



                </graffiti-discover>
              </template>
            </template>

            <template v-if="selectedChannel && currentTab === 'forums'">
              <div class="forum-thread">
                <button @click="goBackToForums" class="forum-back-button">← Back to Forums</button>

                <!-- Forum metadata header -->
                <graffiti-discover
                  v-slot="{ objects: forumMeta }"
                  :channels="['global-forums']"
                  :schema="{
                    properties: {
                      value: {
                        required: ['activity', 'object'],
                        properties: {
                          activity: { const: 'Create' },
                          object: {
                            required: ['type', 'name', 'topic', 'channel'],
                            properties: {
                              type: { const: 'Forum' },
                              name: { type: 'string' },
                              topic: { type: 'string' },
                              channel: { type: 'string' },
                              description: { type: 'string' },
                              icon: { type: 'string' }
                            }
                          }
                        }
                      }
                    }
                  }"
                >
                  <template v-if="(meta = forumMeta.find(f => f.value.object.channel === selectedChannel))">
                    <div class="forum-header">
                      <div class="forum-icon-wrapper" v-if="meta.value.object.icon">
                        <graffiti-get
                          :url="meta.value.object.icon"
                          :schema="graffitiFileSchema"
                          v-slot="{ object }"
                        >
                          <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
                            <img :src="fileDataUrl" class="forum-header-icon" />
                          </graffiti-object-to-file>
                        </graffiti-get>
                      </div>
                      <div>
                        <h2 class="forum-title">{{ meta.value.object.name }}</h2>
                        <p class="forum-topic">Topic: #{{ meta.value.object.topic }}</p>
                        <p class="forum-description">{{ meta.value.object.description }}</p>
                      </div>
                    </div>
                  </template>
                </graffiti-discover>

                <!-- Forum messages -->
                <div class="forum-messages">
                  <graffiti-discover
                    v-slot="{ objects: messages }"
                    :channels="[selectedChannel]"
                    :schema="{
                      properties: {
                        value: {
                          required: ['content', 'published'],
                          properties: {
                            content: { type: 'string' },
                            published: { type: 'number' }
                          }
                        }
                      }
                    }"
                  >
                    <div v-for="msg in messages.sort((a, b) => a.value.published - b.value.published)" :key="msg.url" class="forum-post">
                      <div class="post-header">
                        <div class="message-header">
                          <!-- show profile icon beside username -->
                          <graffiti-discover
                            v-slot="{ objects: userProfiles }"
                            :channels="[msg.actor]"
                            :schema="{
                              properties: {
                                value: {
                                  required: ['describes'],
                                  properties: {
                                    describes: { type: 'string' },
                                    icon: { type: 'string' },
                                    published: { type: 'number' }
                                  }
                                }
                              }
                            }"
                          >
                            <graffiti-get
                              v-if="userProfiles.length && userProfiles[0].value.icon"
                              :url="userProfiles.sort((a, b) => (b.value.published || 0) - (a.value.published || 0))[0].value.icon"
                              :schema="graffitiFileSchema"
                              v-slot="{ object }"
                            >
                              <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
                                <img :src="fileDataUrl" class="avatar-small" />
                              </graffiti-object-to-file>
                            </graffiti-get>

                            <img v-else src="media/blank-profile-picture.webp" class="avatar-small" />

                            <strong
                              @click="viewUserProfile(msg.actor)"
                              class="clickable-username"
                            >
                              {{ getShortUsername(msg.actor) }}
                            </strong>
                          </graffiti-discover>
                        </div>

                        <span class="post-date">{{ new Date(msg.value.published).toLocaleString() }}</span>
                      </div>
                      <div class="post-body">
                        <p>{{ msg.value.content }}</p>
                      </div>
                    </div>
                  </graffiti-discover>
                </div>

                <!-- Message composer -->
                <form @submit.prevent="sendMessage($graffitiSession.value)" class="forum-compose-form">
                  <textarea v-model="myMessage" placeholder="Write a reply..." rows="3"></textarea>
                  <button type="submit">Post Reply</button>
                </form>
              </div>
            </template>




              </section>


            <section v-if="currentTab === 'channels'" id="channels">

              <!-- animation for when you accept invitations later -->
              <transition name="slide-fade">
                <div v-if="showWelcome" class="welcome-banner">{{ welcomeMessage }}</div>
              </transition>


              <!-- hide when channel is open -->
              <template v-if="!selectedChannel">
                <h3>Your Channels</h3>

                 <!-- toggle button to make a new channel -->

                 <button @click="showNewChannelModal = !showNewChannelModal">
                  {{ showNewChannelModal ? 'Hide New Channel Form' : 'New Channel' }}
                </button>

                <Popup v-if="showNewChannelModal" @close="showNewChannelModal = false">
                  <h3>Make a New Channel!</h3>
                  <form @submit.prevent="createPrivateChannel($graffitiSession.value)">
                      <input v-model="newChannelName" placeholder="Channel Name" />
                      <input v-model="newChannelTopic" placeholder="Topic Tag (e.g. show, book)" />
                      <input v-model="invitedUserId" placeholder="Invite User (user ID, optional)" />
                      <input type="file" @change="upload_file" />
                      <button type="submit">Create</button>
                  </form>
                </Popup>

                <!-- toggle for Channel Invitations -->
              <button @click="showInvitations = !showInvitations">
                {{ showInvitations ? 'Hide Invitations' : 'Channel Invitations' }}
              </button>

              <Popup v-if="showInvitations" @close="showInvitations = false">
                <graffiti-discover
                    v-slot="{ objects: inviteObjects }"
                    :channels="['channel-invites']"
                    :schema="{
                        properties: {
                            value: {
                                required: ['activity', 'object', 'target'],
                                properties: {
                                    activity: { const: 'Add' },
                                    object: { type: 'string' },
                                    target: { type: 'string' }
                                }
                            }
                        }
                    }"
                >
                    <graffiti-discover
                        v-slot="{ objects: createObjects }"
                        :channels="['private-channel-directory']"
                        :schema="{
                            properties: {
                                value: {
                                    required: ['activity', 'object'],
                                    properties: {
                                        activity: { const: 'Create' },
                                        object: {
                                            required: ['type', 'name', 'channel'],
                                            properties: {
                                                type: { const: 'PrivateChannel' },
                                                name: { type: 'string' },
                                                topic: { type: 'string' },
                                                channel: { type: 'string' }
                                            }
                                        }
                                    }
                                }
                            }
                        }"
                    >
                        <h3>Channel Invitations</h3>
                        <ul>
                            <li v-for="invite in inviteObjects.filter(i => i.value.object === $graffitiSession.value.actor && !joinedChannels.includes(i.value.target))">
                                <span>
                                    Invitation from <strong>{{ getShortUsername(invite.actor) }}</strong> to join:
                                    {{
                                      createObjects.find(o => o.value.object.channel === invite.value.target)?.value.object.name || 'Unnamed'
                                    }}
                                    (Topic:
                                    {{
                                      createObjects.find(o => o.value.object.channel === invite.value.target)?.value.object.topic || 'unknown'
                                    }})
                                  </span>
                                <button @click="join_chat(invite.value.target)">Join</button>
                                <button @click=" delete_invite(invite)">Delete</button>
                            </li>
                        </ul>

                    </graffiti-discover>
                </graffiti-discover>

              </Popup>

                <ul>
                  <li
                    v-for="channelId in [...new Set(joinedChannels)]"
                    :key="channelId"
                    class="channel-card"
                    @click="open_channel(channelId)"
                  >
                  <div class="channel-content">
                      <graffiti-discover
                        v-slot="{ objects: metaObjects }"
                        :channels="['private-channel-directory']"
                        :schema="{
                          properties: {
                            value: {
                              required: ['activity', 'object'],
                              properties: {
                                activity: { const: 'Create' },
                                object: {
                                  required: ['channel', 'name', 'topic'],
                                  properties: {
                                    channel: { type: 'string' },
                                    name: { type: 'string' },
                                    topic: { type: 'string' },
                                    icon: { type: 'string' }
                                  }
                                }
                              }
                            }
                          }
                        }"
                      >
                        <template v-if="metaObjects.length">
                          <template v-if="(meta = metaObjects.find(m => m.value.object.channel === channelId))">
                            <template v-if="meta.value.object.icon">
                              <graffiti-get
                                :url="meta.value.object.icon"
                                :schema="graffitiFileSchema"
                                v-slot="{ object }"
                              >
                                <graffiti-object-to-file :object="object" v-slot="{ fileDataUrl }">
                                  <img
                                    :src="fileDataUrl"
                                    class="channel-icon"
                                    alt="Channel icon"
                                    style="width: 4rem; height: 4rem; border-radius: 1rem; object-fit: cover; margin-right: 1rem"
                                  />
                                </graffiti-object-to-file>
                              </graffiti-get>
                            </template>
                            <template v-else>
                              <img
                                src="media/blank-profile-picture.webp"
                                class="channel-icon"
                                alt="Default icon"
                                style="width: 4rem; height: 4rem; border-radius: 1rem; object-fit: cover; margin-right: 1rem"
                              />
                            </template>

                            <div class="channel-info">
                              <h3>{{ meta.value.object.name }}</h3>
                              <p>{{ meta.value.object.topic }}</p>
                            </div>
                          </template>
                        </template>
                        <template v-else>
                          <div class="channel-info">
                            <h3>Unnamed</h3>
                            <p>Loading metadata…</p>
                          </div>
                        </template>
                      </graffiti-discover>
                    </div>
                  </li>
                </ul>
              </template>




                <template v-if="$graffitiSession.value && selectedChannel">

                  <!-- stuff in sidebar -->
                  <!-- full wrapper including top header bar -->
                <div class="channel-view-wrapper">
                  <div class="channel-top-bar">
                    <button @click="goBackToChannels" class="back-button">← Back</button>

                    <graffiti-discover
                      v-slot="{ objects: metaObjects }"
                      :channels="['private-channel-directory']"
                      :schema="{
                        properties: {
                          value: {
                            required: ['activity', 'object'],
                            properties: {
                              activity: { const: 'Create' },
                              object: {
                                required: ['channel', 'name'],
                                properties: {
                                  channel: { type: 'string' },
                                  name: { type: 'string' },
                                  icon: { type: 'string' }
                                }
                              }
                            }
                          }
                        }
                      }"
                    >
                      <template v-if="(meta = metaObjects.find(m => m.value.object.channel === selectedChannel))">
                        <div class="top-bar-meta">
                          <img
                            :src="meta.value.object.icon || 'media/blank-profile-picture.webp'"
                            alt="Channel icon"
                            class="top-bar-icon"
                          />
                          <div class="top-bar-text">
                            <div class="top-bar-name">{{ meta.value.object.name }}</div>
                            <div class="top-bar-topic">#{{ meta.value.object.topic || 'No topic' }}</div>
                          </div>
                        </div>
                      </template>
                    </graffiti-discover>

                    <button @click="showSidebar = !showSidebar" class="sidebar-toggle">
                      {{ showSidebar ? 'Hide Info' : 'Show Info' }}
                    </button>
                  </div>

                  <div class="channel-layout">




                    <aside :class="['channel-sidebar', { hidden: !showSidebar }]">

                    <!-- Chat name + rename -->
                    <graffiti-discover
                        v-slot="{ objects: nameObjects }"
                        :channels="['designftw']"
                        :schema="{
                            properties: {
                                value: {
                                    required: ['name', 'describes'],
                                    properties: {
                                        name: { type: 'string' },
                                        describes: { type: 'string' }
                                    }
                                }
                            }
                        }"
                    >
                        <h2>{{ current_group_name(nameObjects, selectedChannel) || 'Unnamed Group Chat' }}</h2>
                        <form @submit.prevent="rename_group($graffitiSession.value)">
                            <input v-model="renameBuffer" placeholder="Rename this chat" />
                            <input type="submit" value="Rename" />
                        </form>
                    </graffiti-discover>

                    <!-- list of people in channel -->
                    <graffiti-discover
                        v-slot="{ objects: inviteObjects }"
                        :channels="['channel-invites']"
                        :schema="{
                            properties: {
                                value: {
                                    required: ['activity', 'object', 'target'],
                                    properties: {
                                        activity: { const: 'Add' },
                                        object: { type: 'string' },
                                        target: { type: 'string' }
                                    }
                                }
                            }
                        }"
                    >
                    <!-- channel member functionality -->
                        <div>
                            <h4>Members in this chat:</h4>
                            <ul>
                                <li v-for="invite in inviteObjects.filter(i => i.value.target === selectedChannel)">
                                    {{ getShortUsername(invite.value.object) }}
                                    <span v-if="invite.value.object === $graffitiSession.value.actor"> (you)</span>
                                </li>
                            </ul>
                        </div>

                        <h4>Add Member</h4>
                            <form @submit.prevent="add_person_to_channel($graffitiSession.value)">
                            <input v-model="newMemberId" placeholder="Username (e.g. nonyo)" />
                            <button type="submit">Add</button>
                            </form>

                    </graffiti-discover>

                    </aside>

                    <main class="channel-main">

                    <!-- list of messages, will be most of screen-->
                    <graffiti-discover
                        v-slot="{ objects: messageObjects, isInitialPolling }"
                        :channels="[selectedChannel]"
                        :schema="{
                            properties: {
                                value: {
                                    required: ['content', 'published'],
                                    properties: {
                                        content: { type: 'string' },
                                        published: { type: 'number' }
                                    }
                                }
                            }
                        }"
                    >

                        <ul>
                            <li v-if="isInitialPolling">Loading...</li>
                            <li
                                v-for="(object, index) in messageObjects.sort((a, b) => a.value.published - b.value.published)"
                                :key="object.url"
                                :ref="index === messageObjects.length - 1 ? 'newMessage' : null"
                                :class="{ 'message-slide-in': index === messageObjects.length - 1 }"
                              >
                                <strong @click="viewUserProfile(object.actor)" class="clickable-username">
                                  {{ getShortUsername(object.actor) }}
                                  <span v-if="object.actor === $graffitiSession.value.actor">(you)</span>
                                </strong>
                                :
                                <em style="font-size: 0.8em; color: gray; margin-left: 6px;">
                                    {{ new Date(object.value.published).toLocaleString() }}
                                </em><br />
                                <span
                                  v-if="editing !== object.url"
                                  :class="{ 'system-message': object.value.system }"
                                >
                                  {{ object.value.content }}
                                </span>

                                <input v-else v-model="editBuffer" @keyup.enter="submitEdit(object)" />

                               <div
                                  class="message-actions"
                                  v-if="object.actor === $graffitiSession.value.actor"
                                >
                                    <button v-if="editing !== object.url" @click="startEditing(object)">✏️</button>
                                    <button @click="deleteMessage(object)">🗑️</button>
                              </div>
                            </li>
                        </ul>
                    </graffiti-discover>

                    <!-- send a message -->
                    <form @submit.prevent="sendMessage($graffitiSession.value)">
                        <fieldset :disabled="sending">
                            <input
                                type="text"
                                v-model="myMessage"
                                placeholder="Message"
                                ref="messageInput"
                                v-focus
                            />
                            <input type="submit" :value="sending ? 'Sending...' : 'Send'" />
                        </fieldset>
                    </form>
                  </main>
                  </div>
                </template>

            </section>
        </div>

        <script src="index.js" type="module"></script>
    </body>
</html>
